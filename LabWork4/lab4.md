# Лабораторная работа 4
## Проектирование REST API

## Цель работы
Получить опыт проектирования программного интерфейса.

## Документация по API
### Принятые проектные решения
1. Архитектурное разбиение на сервисы по ответственностям
   - Бек разделён на доменные области: API-слой, оркестратор RAG, индексатор, интеграция с VCS, хранилища (vector + metadata), очередь/воркеры.
   - Причина: независимое масштабирование и упрощение сопровождения.
2. RAG как основной механизм ответа
   - Бек не “угадывает” по модели, а сначала извлекает релевантные фрагменты из индекса и только затем формирует ответ.
   - Причина: привязка ответа к коду/докам репозитория и управляемость качества.
3. Конвейерная обработка запроса (pipeline)
   - Внутри RAG-сервиса этапы разделены: нормализация запроса -> retrieval -> (опционально) rerank -> сбор контекста -> построение prompt -> вызов LLM -> постобработка.
   - Причина: тестируемость, возможность заменять этапы без переписывания всего сервиса.
4. Два типа хранилищ: Vector DB и реляционная БД
   - Vector DB хранит эмбеддинги чанков и обеспечивает kNN/semantic search.
   - Реляционная БД хранит метаданные (репозитории, документы, версии индекса, статусы задач, аудит, связи “файл -> чанки”).
   - Причина: разные модели доступа/индексации и разные требования к транзакционности.
5. Инкрементальная индексация вместо полной переиндексации
   - При изменениях обрабатываются только затронутые файлы/чанки; поддерживается версия/ревизия индекса.
   - Причина: ускорение обновлений и снижение нагрузки.
6. Асинхронность тяжёлых операций через очередь и воркеры
   - Индексация, переиндексация, массовая загрузка репо выполняются воркерами, запуск — через постановку задач в очередь.
   - Причина: API остаётся отзывчивым, управление ретраями/распараллеливанием.
7. Идемпотентность и повторяемость задач индексатора
   - Задачи индексирования проектируются так, чтобы повторный запуск не ломал состояние: одинаковый вход → одинаковый результат (или безопасное обновление).
   - Причина: надёжность при сбоях воркеров/очереди.
8. Единая модель идентификации сущностей
   - Вводятся стабильные идентификаторы: repo_id, document_id, chunk_id, index_version, job_id.
   - Причина: корректные связи между метаданными и векторами.
9. Контроль доступа на стороне бекенда
   - Бек проверяет права пользователя на репозиторий/ветку/проект на основе данных интеграции с VCS/SSO; запрещает выдачу контекста из недоступных репозиториев.
   - Причина: безопасность и соответствие корпоративным требованиям.

## Эндпоинты
1. Регистрация репозитория\
POST /api/v1/repos\
Создаёт запись репозитория в системе (URL/проект/ветка по умолчанию/настройки).\
Request body:
```json
{
  "name": "backend_repo",
  "vcs_url": "https://gitlab.example.com/app1_group/backend_repo",
  "default_ref": "main"
}
```
Responses:
   - 201 Created
   ```json
   { "repo_uuid": "79fd7e3a-93f4-44dd-b8ea-87090fea36a2", "status": "created" }
   ```
   - 400 Bad Request
   - 409 Conflict

2. Список репозиториев\
GET /api/v1/repos\
Возвращает репозитории, доступные пользователю (с учётом прав)
Responses:
   - Response 200
   ```json
   [
   { "repo_uuid": "79fd7e3a-93f4-44dd-b8ea-87090fea36a2", "name": "backend_repo", "default_ref": "main" }
   ]
   ```
   
3. Запуск индексации (задача в очередь) \
POST /api/v1/repos/{repo_id}/index-jobs \
Ставит задачу индексирования (full или incremental) для ref/commit.
Request body:
```json
{
  "ref": "main",
  "mode": "incremental"
}
```
Responses:
   - Response 202
   ```json
   { "job_uuid": "1b9096f5-dfa3-4c6a-a90e-bb2f3a4966b2", "status": "queued" }
   ```

4. Проверка статуса задачи индексации \
GET /api/v1/index-jobs/{job_id} \
Статус: queued/running/succeeded/failed + прогресс/ошибка.
Responses:
   - Response 200
   ```json
   {
     "job_uuid": "1b9096f5-dfa3-4c6a-a90e-bb2f3a4966b2",
     "status": "running",
     "progress": 0.35,
     "started_at": "2026-01-26T10:12:00Z"
   }
   ```
   
5. Поиск по базе знаний (retrieval)
POST /api/v1/search
Семантический поиск по чанкам: возвращает топ-N фрагментов (для дебага retrieval и для отчёта).
Request body:
```json
{
  "repo_uuid": "79fd7e3a-93f4-44dd-b8ea-87090fea36a2",
  "ref": "main",
  "query": "Опиши микросервис аналитики",
  "top_k": 5
}
```
Response:
   - Response 200
   ```json
   {
     "items": [
       {
         "chunk_uuid": "808d1366-384f-479b-ae5e-8f435a03cc29",
         "path": "analytics/src/chunk_analyzer.py",
         "score": 0.82,
         "snippet": "..."
       }
     ]
   }
   ```

6. Вопрос-ответ (RAG chat)
POST /api/v1/chat/completions
Возвращает финальный ответ LLM + ссылки на источники
Request Body:
```json
{
  "repo_uuid": "79fd7e3a-93f4-44dd-b8ea-87090fea36a2",
  "ref": "main",
  "question": "Скажи, почему пайплайн не срабатывает на 3 стадии?",
  "max_sources": 3
}
```
Response:
   - Response 200
   ```json
   {
     "answer": "...",
     "sources": [
       { "path": ".gitlab-ci.yml", "chunk_uuid": "0f486e7f-fa8a-41aa-b66a-1e4899ad16d4" }
     ]
   }
   ```

7. Обновление настроек репозитория
PUT /api/v1/repos/{repo_id}
Обновляет параметры репозитория (например, имя и ветку по умолчанию).
Request body:
```json
{
  "name": "backend_repo_v2",
  "default_ref": "develop"
}
```
Responses:
   - Response 200
   ```
   {
      "repo_uuid": "79fd7e3a-93f4-44dd-b8ea-87090fea36a2",
      "status": "updated",
      "name": "backend_repo_v2",
      "default_ref": "develop"
   }
   ```
   - 400 Bad Request
   - 404 Not Found
   - 409 Conflict

8. Удаление репозитория и связанных данных
DELETE /api/v1/repos/{repo_id}
Удаляет запись репозитория из системы и связанные данные индекса
Responses:
   - 204 No Content
   - 404 Not Found
   - 409 Conflict